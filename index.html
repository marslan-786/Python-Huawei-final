<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heavy Background Remover</title>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: monospace; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { text-align: center; border: 2px solid #30363d; padding: 40px; border-radius: 10px; background: #161b22; width: 400px; }
        h1 { color: #58a6ff; }
        .status-box { margin: 20px 0; padding: 15px; border-radius: 5px; background: #21262d; border: 1px solid #30363d; }
        button { width: 100%; padding: 15px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-upload { background: #238636; color: white; }
        .btn-download { background: #1f6feb; color: white; display: none; } /* Hidden by default */
        .loader { display: none; margin: 20px auto; border: 4px solid #f3f3f3; border-top: 4px solid #58a6ff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è SERVER PROCESSOR</h1>
        
        <div class="status-box">
            STATUS: <span id="statusText" style="color: #e3b341;">Checking...</span>
            <div class="loader" id="loader"></div>
        </div>

        <div id="uploadArea">
            <input type="file" id="fileInput" multiple accept="image/*" style="margin-bottom: 10px;">
            <button class="btn-upload" onclick="uploadFiles()">üöÄ START UPLOAD</button>
        </div>

        <a href="/download" id="downloadLink">
            <button class="btn-download" id="downloadBtn">üì• DOWNLOAD RESULT (ZIP)</button>
        </a>
    </div>

    <script>
        const statusText = document.getElementById('statusText');
        const loader = document.getElementById('loader');
        const uploadArea = document.getElementById('uploadArea');
        const downloadBtn = document.getElementById('downloadBtn');

        // Check Status Every 3 Seconds
        setInterval(checkStatus, 3000);

        async function checkStatus() {
            try {
                const res = await fetch('/status');
                const data = await res.json();
                
                statusText.innerText = data.message;

                if (data.state === 'processing') {
                    loader.style.display = 'block';
                    uploadArea.style.display = 'none';
                    downloadBtn.style.display = 'none';
                    statusText.style.color = '#e3b341'; // Yellow
                } 
                else if (data.state === 'done') {
                    loader.style.display = 'none';
                    uploadArea.style.display = 'block'; // Allow new upload
                    downloadBtn.style.display = 'block'; // Show Download
                    statusText.style.color = '#2ea043'; // Green
                } 
                else {
                    loader.style.display = 'none';
                    uploadArea.style.display = 'block';
                    downloadBtn.style.display = 'none';
                    statusText.style.color = '#c9d1d9';
                }
            } catch (e) { console.log("Connection error"); }
        }

        async function uploadFiles() {
            const files = document.getElementById('fileInput').files;
            if (files.length === 0) return alert("Select files first!");

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) formData.append('files', files[i]);

            statusText.innerText = "Uploading...";
            loader.style.display = 'block';

            await fetch('/upload', { method: 'POST', body: formData });
            // No need to wait for response, the interval will pick up the 'processing' status
        }
    </script>
</body>
</html>